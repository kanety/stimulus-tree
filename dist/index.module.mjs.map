{"version":3,"file":"index.module.mjs","sources":["../src/store.js","../src/keyboard.js","../src/loader.js","../src/index.js"],"sourcesContent":["export default class Store {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get key() {\n    return this.controller.storeKeyValue;\n  }\n\n  get nodes() {\n    return this.controller.nodes;\n  }\n\n  get openedNodes() {\n    return this.controller.openedNodes;\n  }\n  \n  load() {\n    if (!this.key) return;\n\n    let ids = this.constructor.load(this.key);\n    if (!ids) return;\n\n    let idSet = new Set(ids);\n    this.nodes.forEach(node => {\n      if (idSet.has(node.getAttribute('data-node-id'))) {\n        this.controller.show(node);\n      } else {\n        this.controller.hide(node);\n      }\n    });\n  }\n\n  save() {\n    if (!this.key) return;\n\n    let ids = this.openedNodes.map(node => node.getAttribute('data-node-id'));\n    this.constructor.save(this.key, ids);\n  }\n\n  static load(key) {\n    let json = sessionStorage.getItem(key);\n    try {\n      return JSON.parse(json)\n    } catch(error) {\n      console.error(error);\n      return null;\n    }\n  }\n\n  static save(key, value) {\n    try {\n      sessionStorage.setItem(key, JSON.stringify(value));\n    } catch(error) {\n      console.error(error);\n      return null;\n    }\n  }\n}\n","export default class Keyboard {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get visibleIcons() {\n    let nodes = this.controller.visibleNodes.filter(node => !this.controller.isLeaf(node));\n    return nodes.map(node => this.controller.findIcon(node));\n  }\n\n  keydown(e) {\n    if (!this.controller.isIcon(e.target)) return;\n\n    let node = e.target.parentElement;\n\n    switch (e.code) {\n    case 'ArrowLeft':\n      this.moveLeft(node);\n      e.preventDefault();\n      break;\n    case 'ArrowUp':\n      this.moveUp(node);\n      e.preventDefault();\n      break;\n    case 'ArrowRight':\n      this.moveRight(node);\n      e.preventDefault();\n      break;\n    case 'ArrowDown':\n      this.moveDown(node);\n      e.preventDefault();\n      break;\n    }\n  }\n\n  moveUp(node) {\n    let icons = this.visibleIcons;\n    let index = icons.indexOf(this.controller.findIcon(node)) - 1;\n    if (index >= 0 && icons[index]) icons[index].focus();\n  }\n\n  moveDown(node) {\n    let icons = this.visibleIcons;\n    let index = icons.indexOf(this.controller.findIcon(node)) + 1;\n    if (index >= 0 && icons[index]) icons[index].focus();\n  }\n\n  moveRight(node) {\n    if (this.controller.isOpened(node)) {\n      let child = this.controller.children(node)[0];\n      if (child) {\n        let icon = this.controller.findIcon(child);\n        if (icon) icon.focus();\n      }\n    } else {\n      this.controller.open(node);\n    }\n  }\n\n  moveLeft(node) {\n    if (!this.controller.isOpened(node)) {\n      let parent = this.controller.parent(node);\n      if (parent) {\n        let icon = this.controller.findIcon(parent)\n        if (icon) icon.focus();\n      }\n    } else {\n      this.controller.close(node);\n    }\n  }\n}\n","export default class Loader {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  init() {\n    this.controller.roots.forEach(root => this.loadDescs(root));\n  }\n\n  loadDescs(origin) {\n    let nodes = this.controller.descendants(origin).filter(node => {\n      return this.controller.isLazy(node) && this.controller.isOpened(node) && !this.controller.isLazyLoaded(node)\n    });\n    nodes.forEach(node => this.load(node));\n  }\n\n  async load(node) {\n    node.setAttribute('aria-busy', 'true');\n\n    try {\n      let response = await fetch(node.getAttribute('data-node-lazy'), {\n        headers: {\n          'X-Requested-With': 'XMLHttpRequest'\n        }\n      });\n      if (response.ok) {\n        let text = await response.text();\n        this.loaded(node, text);\n        this.loadDescs(node);\n      }\n    } catch(e) {\n      console.error(e);\n    }\n\n    node.removeAttribute('aria-busy');\n  }\n\n  loaded(node, html) {\n    this.replace(node, html);\n    this.controller.initDescs(node);\n    this.controller.store.save();\n    this.controller.dispatch('loaded', { detail: { node: node, html: html } });\n  }\n\n  replace(node, html) {\n    let nodeID = node.getAttribute('data-node-id');\n    let tmp = document.createElement('div');\n    tmp.innerHTML = html;\n    node.innerHTML = tmp.querySelector(`[data-node-id=\"${nodeID}\"]`).innerHTML;\n    this.controller.setLazyLoaded(node);\n  }\n}\n","import { Controller } from '@hotwired/stimulus';\nimport '@kanety/stimulus-static-actions';\nimport Store from './store';\nimport Keyboard from './keyboard';\nimport Loader from './loader';\nimport './index.scss';\n\nexport default class extends Controller {\n  static values = {\n    storeKey: String\n  };\n  static actions = [\n    ['element', 'click->toggle'],\n    ['element', 'keydown->keydown']\n  ];\n\n  get roots() {\n    return Array.from(this.element.children);\n  }\n\n  get nodes() {\n    return this.scope.findAllElements('li');\n  }\n\n  get openedNodes() {\n    return this.nodes.filter(node => this.isOpened(node));\n  }\n\n  get visibleNodes() {\n    return this.nodes.filter(node => this.ancestors(node).slice(0, -1).every(a => this.isOpened(a)));\n  }\n\n  connect() {\n    this.init();\n    this.keyboard = new Keyboard(this);\n    this.store = new Store(this);\n    this.store.load();\n    this.loader = new Loader(this);\n    this.loader.init();\n  }\n\n  init() {\n    this.roots.forEach(root => this.initDescs(root));\n  }\n\n  initDescs(origin) {\n    this.descendants(origin).forEach(node => {\n      if (this.children(node).length == 0 && !this.isLazy(node)) {\n        node.classList.add('st-tree__node--leaf', 'st-tree__node--closed');\n      }\n    });\n  }\n\n  toggle(e) {\n    if (!this.isIcon(e.target)) return;\n\n    let node = e.target.parentElement;\n    if (this.isOpened(node)) {\n      this.close(node);\n    } else {\n      this.open(node);\n    }\n\n    e.preventDefault();\n  }\n\n  expand(e) {\n    this.nodes.filter(node => !this.isOpened(node)).forEach(node => this.open(node));\n  }\n\n  collapse(e) {\n    this.nodes.filter(node => this.isOpened(node)).forEach(node => this.close(node));\n  }\n\n  keydown(e) {\n    this.keyboard.keydown(e);\n  }\n\n  open(node) {\n    this.show(node);\n    this.store.save();\n    this.dispatch('opened', { detail: { node: node } });\n\n    if (this.isLazy(node) && !this.isLazyLoaded(node)) {\n      this.loader.load(node);\n    }\n  }\n\n  close(node) {\n    this.hide(node);\n    this.store.save();\n    this.dispatch('closed', { detail: { node: node } });\n  }\n\n  show(node) {\n    node.classList.remove('st-tree__node--closed');\n  }\n\n  hide(node) {\n    node.classList.add('st-tree__node--closed');\n  }\n\n  parent(node) {\n    let parent = node.parentElement.parentElement;\n    return parent && parent.matches('li') ? parent : null;\n  }\n\n  children(node) {\n    let ul = Array.from(node.children).find(child => child.matches('ul'));\n    return ul ? Array.from(ul.children) : [];\n  }\n\n  ancestors(node) {\n    let parent = this.parent(node);\n    return parent ? this.ancestors(parent).concat([node]) : [node];\n  }\n\n  descendants(node) {\n    return [node].concat(this.children(node).flatMap(child => this.descendants(child)));\n  }\n\n  isOpened(node) {\n    return !node.matches('.st-tree__node--closed');\n  }\n\n  isLeaf(node) {\n    return node.matches('.st-tree__node--leaf');\n  }\n\n  findIcon(node) {\n    return node.querySelector('a[href=\"#icon\"]');\n  }\n\n  isIcon(elem) {\n    return elem.matches('a[href=\"#icon\"]');\n  }\n\n  isLazy(node) {\n    return node.matches('[data-node-lazy]');\n  }\n\n  isLazyLoaded(node) {\n    return node.matches('[data-node-lazy-loaded]') || this.children(node).length != 0;\n  }\n\n  setLazyLoaded(node) {\n    node.setAttribute('data-node-lazy-loaded', 'true');\n  }\n}\n"],"names":["Store","constructor","controller","this","key","storeKeyValue","nodes","openedNodes","load","ids","idSet","Set","forEach","node","has","getAttribute","show","hide","save","map","json","sessionStorage","getItem","JSON","parse","error","console","value","setItem","stringify","Keyboard","visibleIcons","visibleNodes","filter","isLeaf","findIcon","keydown","e","isIcon","target","parentElement","code","moveLeft","preventDefault","moveUp","moveRight","moveDown","icons","index","indexOf","focus","isOpened","child","children","icon","open","close","parent","Loader","init","roots","root","loadDescs","origin","descendants","isLazy","isLazyLoaded","_this","_temp3","removeAttribute","setAttribute","_temp2","body","recover","result","Promise","resolve","fetch","headers","then","response","_temp","ok","text","loaded","_catch","reject","html","replace","initDescs","store","dispatch","detail","nodeID","tmp","document","createElement","innerHTML","querySelector","setLazyLoaded","_Class","Controller","Array","from","element","scope","findAllElements","ancestors","slice","every","a","connect","keyboard","loader","length","classList","add","toggle","expand","collapse","remove","matches","ul","find","concat","flatMap","elem","values","storeKey","String","actions"],"mappings":"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"}