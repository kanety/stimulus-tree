{"version":3,"file":"index.js","sources":["../src/store.js","../src/keyboard.js","../src/index.js"],"sourcesContent":["export default class Store {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get key() {\n    return this.controller.storeKeyValue;\n  }\n\n  get nodes() {\n    return this.controller.nodes;\n  }\n\n  get openedNodes() {\n    return this.controller.openedNodes;\n  }\n  \n  load() {\n    if (!this.key) return;\n\n    let ids = this.constructor.load(this.key);\n    if (!ids) return;\n\n    let idSet = new Set(ids);\n    this.nodes.forEach(node => {\n      if (idSet.has(node.getAttribute('data-node-id'))) {\n        this.controller.show(node);\n      } else {\n        this.controller.hide(node);\n      }\n    });\n  }\n\n  save() {\n    if (!this.key) return;\n\n    let ids = this.openedNodes.map(node => node.getAttribute('data-node-id'));\n    this.constructor.save(this.key, ids);\n  }\n\n  static load(key) {\n    let json = sessionStorage.getItem(key);\n    try {\n      return JSON.parse(json)\n    } catch(error) {\n      console.error(error);\n      return null;\n    }\n  }\n\n  static save(key, value) {\n    try {\n      sessionStorage.setItem(key, JSON.stringify(value));\n    } catch(error) {\n      console.error(error);\n      return null;\n    }\n  }\n}\n","export default class Keyboard {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get nodes() {\n    return this.controller.nodes;\n  }\n\n  get visibleNodes() {\n    return this.nodes.filter(node => !node.parentNode.closest('li.st-tree__node--closed'));\n  }\n\n  get visibleIcons() {\n    return this.visibleNodes.filter(node => !node.matches('.st-tree__node--leaf')).map(node => this.findIcon(node));\n  }\n\n  keydown(e) {\n    if (!e.target.matches('a[href=\"#icon\"]')) return;\n\n    let node = e.target.parentNode;\n\n    switch (e.keyCode) {\n    case 37: // left\n      this.moveLeft(node);\n      e.preventDefault();\n      break;\n    case 38: // up\n      this.moveUp(node);\n      e.preventDefault();\n      break;\n    case 39: // right\n      this.moveRight(node);\n      e.preventDefault();\n      break;\n    case 40: // down\n      this.moveDown(node);\n      e.preventDefault();\n      break;\n    }\n  }\n\n  moveUp(node) {\n    let icons = this.visibleIcons;\n    let index = icons.indexOf(this.findIcon(node)) - 1;\n    if (index >= 0 && icons[index]) icons[index].focus();\n  }\n\n  moveDown(node) {\n    let icons = this.visibleIcons;\n    let index = icons.indexOf(this.findIcon(node)) + 1;\n    if (index >= 0 && icons[index]) icons[index].focus();\n  }\n\n  moveRight(node) {\n    if (!node.matches('.st-tree__node--closed')) {\n      let icon = this.findIcon(node.querySelector('ul:first-of-type > li:first-of-type'));\n      if (icon) icon.focus();\n    } else {\n      this.controller.open(node);\n    }\n  }\n\n  moveLeft(node) {\n    if (node.matches('.st-tree__node--closed')) {\n      let icon = this.findIcon(node.parentNode.parentNode)\n      if (icon) icon.focus();\n    } else {\n      this.controller.close(node);\n    }\n  }\n\n  findIcon(node) {\n    return node.querySelector('a[href=\"#icon\"]');\n  }\n}\n","import { Controller } from '@hotwired/stimulus';\nimport '@kanety/stimulus-static-actions';\nimport Store from './store';\nimport Keyboard from './keyboard';\nimport './index.scss';\n\nexport default class extends Controller {\n  static values = {\n    storeKey: String\n  };\n  static actions = [\n    ['element', 'click->toggle'],\n    ['element', 'keydown->keydown'],\n    ['element', ':expand->expand'],\n    ['element', ':collapse->collapse']\n  ];\n\n  get nodes() {\n    return this.scope.findAllElements('li');\n  }\n\n  get openedNodes() {\n    return this.scope.findAllElements('li:not(.st-tree__node--closed)');\n  }\n  \n  connect() {\n    this.init();\n    this.keyboard = new Keyboard(this);\n    this.store = new Store(this);\n    this.store.load();\n  }\n\n  init() {\n    this.nodes.forEach(node => {\n      if (!this.hasChildren(node)) {\n        node.classList.add('st-tree__node--leaf', 'st-tree__node--closed');\n      }\n    });\n  }\n\n  toggle(e) {\n    if (!e.target.matches('a[href=\"#icon\"]')) return;\n\n    let node = e.target.parentNode;\n    if (node.matches('.st-tree__node--closed')) {\n      this.open(node);\n    } else {\n      this.close(node);\n    }\n\n    e.preventDefault();\n  }\n\n  expand(e) {\n    this.nodes.forEach(node => this.show(node));\n    this.store.save();\n  }\n\n  collapse(e) {\n    this.nodes.forEach(node => this.hide(node));\n    this.store.save();\n  }\n\n  keydown(e) {\n    this.keyboard.keydown(e);\n  }\n\n  open(node) {\n    this.show(node);\n    this.store.save();\n    this.dispatch('opened', { detail: { node: node } });\n  }\n\n  close(node) {\n    this.hide(node);\n    this.store.save();\n    this.dispatch('closed', { detail: { node: node } });\n  }\n\n  show(node) {\n    node.classList.remove('st-tree__node--closed');\n  }\n\n  hide(node) {\n    node.classList.add('st-tree__node--closed');\n  }\n\n  hasChildren(node) {\n    return Array.from(node.children).some(child => child.matches('ul'));\n  }\n}\n"],"names":["Store","constructor","controller","this","key","storeKeyValue","nodes","openedNodes","load","ids","idSet","Set","forEach","node","has","getAttribute","show","hide","save","map","static","json","sessionStorage","getItem","JSON","parse","error","console","value","setItem","stringify","Keyboard","visibleNodes","filter","parentNode","closest","visibleIcons","matches","findIcon","keydown","e","target","keyCode","moveLeft","preventDefault","moveUp","moveRight","moveDown","icons","index","indexOf","focus","open","icon","querySelector","close","Controller","scope","findAllElements","connect","init","keyboard","store","hasChildren","classList","add","toggle","expand","collapse","dispatch","detail","remove","Array","from","children","some","child","values","storeKey","String","actions"],"mappings":"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"}