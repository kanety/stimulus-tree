{"version":3,"file":"index.umd.js","sources":["../src/store.js","../src/keyboard.js","../src/index.js"],"sourcesContent":["export default class Store {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get key() {\n    return this.controller.storeKeyValue;\n  }\n\n  get nodes() {\n    return this.controller.nodes;\n  }\n\n  get openedNodes() {\n    return this.controller.openedNodes;\n  }\n  \n  load() {\n    if (!this.key) return;\n\n    let ids = this.constructor.load(this.key);\n    if (!ids) return;\n\n    let idSet = new Set(ids);\n    this.nodes.forEach(node => {\n      if (idSet.has(node.getAttribute('data-node-id'))) {\n        this.controller.show(node);\n      } else {\n        this.controller.hide(node);\n      }\n    });\n  }\n\n  save() {\n    if (!this.key) return;\n\n    let ids = this.openedNodes.map(node => node.getAttribute('data-node-id'));\n    this.constructor.save(this.key, ids);\n  }\n\n  static load(key) {\n    let json = sessionStorage.getItem(key);\n    try {\n      return JSON.parse(json)\n    } catch(error) {\n      console.error(error);\n      return null;\n    }\n  }\n\n  static save(key, value) {\n    try {\n      sessionStorage.setItem(key, JSON.stringify(value));\n    } catch(error) {\n      console.error(error);\n      return null;\n    }\n  }\n}\n","export default class Keyboard {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get visibleIcons() {\n    let nodes = this.controller.visibleNodes.filter(node => !this.controller.isLeaf(node));\n    return nodes.map(node => this.controller.findIcon(node));\n  }\n\n  keydown(e) {\n    if (!this.controller.isIcon(e.target)) return;\n\n    let node = e.target.parentElement;\n\n    switch (e.code) {\n    case 'ArrowLeft':\n      this.moveLeft(node);\n      e.preventDefault();\n      break;\n    case 'ArrowUp':\n      this.moveUp(node);\n      e.preventDefault();\n      break;\n    case 'ArrowRight':\n      this.moveRight(node);\n      e.preventDefault();\n      break;\n    case 'ArrowDown':\n      this.moveDown(node);\n      e.preventDefault();\n      break;\n    }\n  }\n\n  moveUp(node) {\n    let icons = this.visibleIcons;\n    let index = icons.indexOf(this.controller.findIcon(node)) - 1;\n    if (index >= 0 && icons[index]) icons[index].focus();\n  }\n\n  moveDown(node) {\n    let icons = this.visibleIcons;\n    let index = icons.indexOf(this.controller.findIcon(node)) + 1;\n    if (index >= 0 && icons[index]) icons[index].focus();\n  }\n\n  moveRight(node) {\n    if (this.controller.isOpened(node)) {\n      let child = this.controller.children(node)[0];\n      if (child) {\n        let icon = this.controller.findIcon(child);\n        if (icon) icon.focus();\n      }\n    } else {\n      let icon = this.controller.findIcon(node);\n      if (icon) icon.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));\n    }\n  }\n\n  moveLeft(node) {\n    if (!this.controller.isOpened(node)) {\n      let parent = this.controller.parent(node);\n      if (parent) {\n        let icon = this.controller.findIcon(parent)\n        if (icon) icon.focus();\n      }\n    } else {\n      let icon = this.controller.findIcon(node);\n      if (icon) icon.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));\n    }\n  }\n}\n","import { Controller } from '@hotwired/stimulus';\nimport '@kanety/stimulus-static-actions';\nimport Store from './store';\nimport Keyboard from './keyboard';\nimport './index.scss';\n\nexport default class extends Controller {\n  static values = {\n    storeKey: String\n  };\n  static actions = [\n    ['element', 'click->toggle'],\n    ['element', 'keydown->keydown']\n  ];\n\n  get roots() {\n    return Array.from(this.element.children);\n  }\n\n  get nodes() {\n    return this.scope.findAllElements('li');\n  }\n\n  get openedNodes() {\n    return this.nodes.filter(node => this.isOpened(node));\n  }\n\n  get visibleNodes() {\n    return this.nodes.filter(node => {\n      let ancestors = this.ancestors(node).slice(0, -1);\n      return ancestors.every(a => this.isOpened(a));\n    });\n  }\n\n  connect() {\n    this.init();\n    this.keyboard = new Keyboard(this);\n    this.store = new Store(this);\n    this.store.load();\n  }\n\n  init() {\n    this.nodes.forEach(node => {\n      if (!this.hasChildList(node)) {\n        node.classList.add('st-tree__node--leaf', 'st-tree__node--closed');\n      }\n    });\n  }\n\n  toggle(e) {\n    if (!this.isIcon(e.target)) return;\n\n    let node = e.target.parentElement;\n\n    if (this.isOpened(node)) {\n      this.close(node);\n    } else {\n      this.open(node);\n    }\n\n    e.preventDefault();\n  }\n\n  expand(e) {\n    this.nodes.forEach(node => this.show(node));\n    this.store.save();\n  }\n\n  collapse(e) {\n    this.nodes.forEach(node => this.hide(node));\n    this.store.save();\n  }\n\n  keydown(e) {\n    this.keyboard.keydown(e);\n  }\n\n  open(node) {\n    this.show(node);\n    this.store.save();\n    this.dispatch('opened', { detail: { node: node } });\n  }\n\n  close(node) {\n    this.hide(node);\n    this.store.save();\n    this.dispatch('closed', { detail: { node: node } });\n  }\n\n  show(node) {\n    node.classList.remove('st-tree__node--closed');\n  }\n\n  hide(node) {\n    node.classList.add('st-tree__node--closed');\n  }\n\n  parent(node) {\n    let parent = node.parentElement.parentElement;\n    return parent && parent.matches('li') ? parent : null;\n  }\n\n  children(node) {\n    let ul = Array.from(node.children).find(child => child.matches('ul'));\n    return ul ? Array.from(ul.children) : [];\n  }\n\n  ancestors(node) {\n    let ancestors = [node];\n    while (node = this.parent(node)) ancestors.unshift(node);\n    return ancestors;\n  }\n\n  descendants(node) {\n    return [node].concat(this.children(node).flatMap(child => this.descendants(child)));\n  }\n\n  hasChildList(node) {\n    return Array.from(node.children).some(child => child.matches('ul'));\n  }\n\n  isOpened(node) {\n    return !node.matches('.st-tree__node--closed');\n  }\n\n  isLeaf(node) {\n    return node.matches('.st-tree__node--leaf');\n  }\n\n  findIcon(node) {\n    return node.querySelector('a[href=\"#icon\"]');\n  }\n\n  isIcon(elem) {\n    return elem.matches('a[href=\"#icon\"]');\n  }\n}\n"],"names":["Store","constructor","controller","this","key","storeKeyValue","nodes","openedNodes","load","ids","idSet","Set","forEach","node","has","getAttribute","show","hide","save","map","static","json","sessionStorage","getItem","JSON","parse","error","console","value","setItem","stringify","Keyboard","visibleIcons","visibleNodes","filter","isLeaf","findIcon","keydown","e","isIcon","target","parentElement","code","moveLeft","preventDefault","moveUp","moveRight","moveDown","icons","index","indexOf","focus","isOpened","child","children","icon","dispatchEvent","MouseEvent","bubbles","cancelable","parent","Controller","roots","Array","from","element","scope","findAllElements","ancestors","slice","every","a","connect","init","keyboard","store","hasChildList","classList","add","toggle","close","open","expand","collapse","dispatch","detail","remove","matches","ul","find","unshift","descendants","concat","flatMap","some","querySelector","elem","values","storeKey","String","actions"],"mappings":"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"}